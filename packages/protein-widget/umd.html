<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="umd/jbrowse-protein-viewer.js" type="text/javascript"></script>

    <style>
      body {
        background: #dbd2fc;
        padding: 50px;
      }
      #protein-viewer {
        border: 1px solid black;
      	margin: 100px auto;
        width: 800px;
      }
      #error-bar {
        background: #ffaaaa;
        width: 800px;
      }
    </style>
  </head>
  <body>
    <h1>Protein Widget Demo Page</h1>
    <p>This is a hand-written little html page. All it does is include the <tt>jbrowse-protein-viewer.js</tt> bundle with a script tag, and then call <tt>new JBrowseProteinViewer.Viewer</tt> with a JSON object of data.</tt></p>
    <form id="myform">
      <input id="geneid" type="text" list="mylist">
        <datalist id="mylist">
        </datalist>
      </input>
      <button>Submit</button>
    </form>
    <div id="spinner-container" style="display: inline"></div>
    <div id="error-bar"></div>
    <div id="protein-viewer"></div>
    <script type="text/javascript">
      const form = document.getElementById('myform')

      let viewer
      let controller
      let signal

      async function updateProteinViewer(geneid) {
        var spinner = document.getElementById('spinner-container');
        const img = document.createElement('img')
        img.src = 'http://www.bakerbotts.com/assets/src/images/loading_spinner.gif'
        img.width=100
        img.height=100
        spinner.appendChild(img)

        fetch(`http://18.218.239.245/protein_data_service/?ensemblGeneId=${geneid}`)
          .then(res => res.json())
          .then(res => {
            if(viewer) {
              viewer.update(res)
            } else {
              viewer = new JBrowseProteinViewer.Viewer(
                document.getElementById('protein-viewer'),
                res,
              );
            }
          })
          .catch(error => {
            document.getElementById('error-bar').textContent = error.message
          }).finally(() => {
            spinner.innerHTML = ""
          })

      }
      form.addEventListener('submit', event => {
        event.preventDefault()
        const geneid = document.getElementById('geneid').value
        updateProteinViewer(geneid)
      })

      document.getElementById('geneid').addEventListener('keyup', async (evt) => {
        if (controller) {
          controller.abort();
        }
        if (AbortController) {
          controller = new AbortController();
          var signal = controller.signal;
        }

        try {
          var mylist = document.getElementById('mylist');
          mylist.innerHTML = ""

          const input = evt.target
          const val = input.value
          if (val.length < 2 ) {
            return
          }
          const ret = await fetch(`https://mygene.info/v3/query?q=${val}&fields=ensembl,name,symbol&species=human`, {signal}).then(res => res.json())
          ret.hits.forEach(item => {
            if(item.ensembl) {
              var option = document.createElement('option');
              option.value = item.ensembl.gene;
              option.label = `${item.symbol} - ${item.name} (${item.ensembl.gene})`
              mylist.append(option)
            }
          })
        } catch(e) {
          if (e.name !== "AbortError") {
            console.error(e)
          }
        }
      })
      updateProteinViewer('ENSG00000133703')
    </script>
  </body>
</html>
